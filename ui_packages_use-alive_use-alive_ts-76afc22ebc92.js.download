"use strict";(globalThis.webpackChunk=globalThis.webpackChunk||[]).push([["ui_packages_use-alive_use-alive_ts"],{15930:(e,t,r)=>{let n;r.d(t,{H:()=>y});var s=r(10204);let AliveSession=class AliveSession extends s.ib{getUrlFromRefreshUrl(){return i(this.refreshUrl)}constructor(e,t,r,n,s){super(e,()=>this.getUrlFromRefreshUrl(),r,n,void 0,s),this.refreshUrl=t}};async function i(e){let t=await o(e);return t&&t.url&&t.token?a(t.url,t.token):null}async function o(e){let t=await fetch(e,{headers:{Accept:"application/json"}});if(t.ok)return t.json();if(404===t.status)return null;throw Error("fetch error")}async function a(e,t){let r=await fetch(e,{method:"POST",mode:"same-origin",headers:{"Scoped-CSRF-Token":t}});if(r.ok)return r.text();throw Error("fetch error")}var l=r(70170),u=r(75028),c=r(80688),d=r(23683),h=r(75632);function f(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}function b(e,{channel:t,type:r,data:n}){for(let s of e)s.dispatchEvent(new CustomEvent(`socket:${r}`,{bubbles:!1,cancelable:!1,detail:{name:t,data:n}}))}let p=class AliveSessionProxy{subscribe(e){let t=this.subscriptions.add(...e);t.length&&this.worker.port.postMessage({subscribe:t});let r=new Set(t.map(e=>e.name)),n=e.reduce((e,t)=>{let n=t.topic.name;return(0,s.JR)(n)&&!r.has(n)&&e.add(n),e},new Set);n.size&&this.worker.port.postMessage({requestPresence:Array.from(n)})}unsubscribeAll(...e){let t=this.subscriptions.drain(...e);t.length&&this.worker.port.postMessage({unsubscribe:t});let r=this.presenceMetadata.removeSubscribers(e);this.sendPresenceMetadataUpdate(r)}updatePresenceMetadata(e){let t=new Set;for(let r of e)this.presenceMetadata.setMetadata(r),t.add(r.channelName);this.sendPresenceMetadataUpdate(t)}sendPresenceMetadataUpdate(e){if(!e.size)return;let t=[];for(let r of e)t.push({channelName:r,metadata:this.presenceMetadata.getChannelMetadata(r)});this.worker.port.postMessage({updatePresenceMetadata:t})}online(){this.worker.port.postMessage({online:!0})}offline(){this.worker.port.postMessage({online:!1})}hangup(){this.worker.port.postMessage({hangup:!0})}receive(e){let{channel:t}=e;if("presence"===e.type){let r=this.notifyPresenceDebouncedByChannel.get(t);r||(r=(0,l.s)((e,r)=>{this.notify(e,r),this.notifyPresenceDebouncedByChannel.delete(t)},100),this.notifyPresenceDebouncedByChannel.set(t,r)),r(this.subscriptions.subscribers(t),e);return}this.notify(this.subscriptions.subscribers(t),e)}constructor(e,t,r,n,i,o){f(this,"worker",void 0),f(this,"subscriptions",new s.m0),f(this,"presenceMetadata",new s.VH),f(this,"notify",void 0),f(this,"notifyPresenceDebouncedByChannel",new Map),this.notify=i,this.worker=new SharedWorker(`${e}?module=true`,{name:`github-socket-worker-v3-${n}`,type:"module"}),this.worker.port.onmessage=({data:e})=>this.receive(e),this.worker.port.postMessage({connect:{url:t,refreshUrl:r,options:o}})}};async function w(){let e=function(){let e=document.head.querySelector("link[rel=shared-web-socket-src]")?.getAttribute("href");return e&&e.startsWith("/")?e:null}();if(!e)return;let t=document.head.querySelector("link[rel=shared-web-socket]")?.href??null;if(!t)return;let r=document.head.querySelector("link[rel=shared-web-socket]")?.getAttribute("data-refresh-url")??null;if(!r)return;let n=document.head.querySelector("link[rel=shared-web-socket]")?.getAttribute("data-session-id")??null;if(!n)return;let s=(()=>{let s=(0,h.G7)("alive_legacy_retries")?{socketPolicy:{timeout:4e3,attempts:7}}:{};if(!(0,d.nr)()&&"SharedWorker"in window&&"true"!==(0,c.A)("localStorage").getItem("bypassSharedWorker"))try{return new p(e,t,r,n,b,s)}catch{}return new AliveSession(t,r,!1,b,s)})();return window.addEventListener("online",()=>s.online()),window.addEventListener("offline",()=>s.offline()),window.addEventListener("pagehide",()=>{"hangup"in s&&s.hangup()}),s}async function m(){return await u.G,w()}function y(){return n||(n=m())}},88853:(e,t,r)=>{r.d(t,{$:()=>a});var n=r(10204),s=r(128),i=r(75632);let o=new WeakMap;function a(e,t,r){let a;if(!e)throw Error("Not connected to alive");if(!t)throw Error("No channel name");let l=n.KK.parse(t);if(!l)throw Error("Invalid channel name");let u={subscriber:{dispatchEvent:e=>{e instanceof CustomEvent&&r(e.detail.data)}},topic:l},c=(0,i.G7)("use_alive_batching")?((a=o.get(e))||(a={subscribe:(0,s.rK)(t=>e.subscribe(t.flat())),unsubscribeAll:(0,s.rK)(t=>e.unsubscribeAll(...t))},o.set(e,a)),a):e;return c.subscribe([u]),{unsubscribe:()=>c.unsubscribeAll(u.subscriber)}}},128:(e,t,r)=>{function n(){return Promise.resolve()}function s(){return new Promise(window.requestAnimationFrame)}async function i(e,t){let r;let n=new Promise(t=>{r=self.setTimeout(t,e)});if(!t)return n;try{var s;await Promise.race([n,(s=t,new Promise((e,t)=>{let r=Error("aborted");r.name="AbortError",s.aborted?t(r):s.addEventListener("abort",()=>t(r))}))])}catch(e){throw self.clearTimeout(r),e}}function o(e){let t=[];return function(r){t.push(r),1===t.length&&queueMicrotask(()=>{let r=t.slice(0);t.length=0,e(r)})}}r.d(t,{G$:()=>s,k2:()=>n,rK:()=>o,uk:()=>i})},99425:(e,t,r)=>{r.d(t,{x:()=>f});var n,s=r(96540),i=r(45996),o=r(15930),a=r(88853),l=r(74848),u=r(10204);let c=(0,s.createContext)(null),d=null;function h(e,t){let r=u.KK.parse(e);if(!r)throw Error(`Invalid channel name. Did you forget to sign it with \`signChannel("${e}")\`?`);return d||(d=new u.m0),d.add({topic:r,subscriber:t}),{unsubscribe:()=>{d?.delete({topic:r,subscriber:t})}}}try{c.displayName||(c.displayName="AliveTestContext")}catch{}try{(n=function({children:e,initialMessages:t}){return(0,s.useEffect)(()=>{let e=[];if(t)for(let[r,n]of t){let t=window.setTimeout(()=>{(function(e,t){if(null===d)throw Error('Test helper `dispatchAliveTestMessage` called outside `AliveTestProvider`. Please wrap your component under test in `AliveTestProvider` from "@github-ui/use-alive/test-utils".');for(let r of Array.from(d.subscribers(e)))r(t)})(r,n)},0);e.push(t)}return()=>{for(let t of(d=null,e))window.clearTimeout(t)}}),(0,l.jsx)(c.Provider,{value:h,children:e})}).displayName||(n.displayName="AliveTestProvider")}catch{}function f(e,t){let r=(0,i.A)(),n=(0,s.useContext)(c);(0,s.useEffect)(()=>{let s=()=>{},i=!1;return async function(){if(e){if("function"==typeof n){let r=await n(e,t);r&&(s=r.unsubscribe);return}try{let n=await (0,o.H)();if(i)return;let l=(0,a.$)(n,e,t);l?.unsubscribe&&(r()?s=l.unsubscribe:l.unsubscribe())}catch(e){console.error(e)}}}(),()=>{i=!0,s()}},[e,t,r,n])}}}]);
//# sourceMappingURL=ui_packages_use-alive_use-alive_ts-1ca3445baefa.js.map